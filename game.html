<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Play — Gurjot’s Games</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" href="styles/profile-overlay.css">
  <style>
    :root {
      color-scheme: dark;
      --shell-bg: var(--shell-gradient, linear-gradient(180deg, #050b1f 0%, #111827 35%, #050b1f 100%));
      --shell-card: var(--card-gradient, linear-gradient(180deg, #141824 0%, #101420 100%));
      --shell-card-solid: var(--card-solid, #121821);
      --shell-border: var(--surface-border-strong, #223049);
      --shell-muted: var(--text-muted, #9db0c5);
      --shell-accent: var(--brand-accent, #4cc9f0);
      --bg: var(--shell-bg);
      --card: var(--shell-card);
      --card-solid: var(--shell-card-solid);
      --muted: var(--shell-muted);
      --accent: var(--shell-accent);
      --error: #ff6b6b;
      --border-strong: var(--shell-border);
      --font-brand:"Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg);
      color: var(--fg, #e5f0ff); font-size: 14px; line-height: 1.5; font-family: var(--font-brand);
    }
    .shell-frame {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 0 20px;
      min-height: 100vh;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      grid-template-rows: auto auto 1fr auto;
      gap: 8px;
      grid-template-areas:
        "header"
        "quest"
        "main"
        "footer";
    }
    body.legacy-shell {
      display: block;
      background: #000;
    }
    body.legacy-shell .shell-frame {
      max-width: none;
      padding: 0;
      min-height: auto;
      display: block;
    }
    header, footer {
      backdrop-filter: blur(6px); background: var(--header-bg, rgba(17,24,39,0.6)); border-bottom: 1px solid var(--border-strong);
    }
    header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; grid-area: header; }
    header .title { display:flex; align-items:center; gap:10px; }
    header .title h1 { font-size: 16px; margin: 0; font-weight: 600; }
    header nav { display:flex; gap:8px; }
    a.btn, button.btn {
      appearance: none; border: 1px solid var(--button-border, #2a3b54); background: var(--button-bg, #0f1622); color: var(--button-fg, var(--fg, #e5f0ff));
      padding: 8px 10px; border-radius: 10px; cursor: pointer; text-decoration: none; font-weight: var(--button-weight, 500);
      transition: transform 0.15s ease, filter 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }
    a.btn:hover, button.btn:hover {
      border-color: color-mix(in srgb, var(--button-border, #2a3b54) 60%, var(--accent) 40%);
      filter: brightness(1.05);
    }
    a.btn:active, button.btn:active {
      transform: translateY(1px);
      filter: brightness(0.95);
    }
    .btn-primary {
      --button-bg: linear-gradient(140deg, #4cc9f0 0%, #4361ee 45%, #3a0ca3 100%);
      --button-border: rgba(67, 97, 238, 0.65);
      --button-fg: #f8fbff;
      --button-weight: 600;
      box-shadow: 0 6px 18px rgba(58, 12, 163, 0.35);
    }
    .btn-primary:hover {
      box-shadow: 0 8px 22px rgba(58, 12, 163, 0.45);
    }
    .btn-primary:active {
      box-shadow: 0 3px 10px rgba(58, 12, 163, 0.35);
    }
    .btn-ghost {
      --button-bg: transparent;
      --button-border: rgba(157, 176, 197, 0.35);
      --button-fg: color-mix(in srgb, #e5f0ff 85%, var(--muted) 15%);
      --button-weight: 500;
      background-color: rgba(15, 22, 34, 0.35);
      box-shadow: inset 0 0 0 1px rgba(12, 18, 28, 0.6);
    }
    .btn-ghost:hover {
      background-color: rgba(67, 97, 238, 0.08);
    }
    .btn-ghost:active {
      background-color: rgba(67, 97, 238, 0.12);
    }
    main { display:grid; place-items:stretch; padding: 0; grid-area: main; }
    .game-card {
      width: 100%; height: 100%; aspect-ratio: auto; background: var(--card); border: 1px solid var(--border-strong);
      border-radius: 14px; overflow: clip; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.45);
    }
    body.legacy-shell .game-card {
      border: 0;
      border-radius: 0;
      box-shadow: none;
    }
    iframe#game-frame { width: 100%; height: 100%; border: 0; background: #000; display:block; }
    .overlay {
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
    }
    body.legacy-shell header,
    body.legacy-shell footer,
    body.legacy-shell .overlay {
      display: none !important;
    }
    body.legacy-shell main {
      padding: 0;
      height: 100vh;
      display: block;
    }
    body.legacy-shell iframe#game-frame {
      height: 100vh;
    }
    .status {
      pointer-events:none; background: var(--panel-bg, rgba(12,18,28,0.92)); border:1px solid var(--border-strong); border-radius:12px;
      padding:16px; width:min(560px, 90%);
      color:var(--panel-fg, #f3f7ff);
    }
    .status .logbox { pointer-events:auto; }
    .status .actions {
      pointer-events:auto;
      display:flex;
      justify-content:flex-end;
      margin-top:8px;
    }
    .status .actions .btn { min-width: 0; }
    .status h2 { margin:0 0 6px; font-size:16px; }
    .status p { margin:6px 0 0; color: var(--muted); }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill { border:1px solid var(--border-strong); padding:6px 8px; border-radius:999px; font-size:12px; color:#cfe2ff; color:color-mix(in srgb, var(--fg, #e5f0ff) 70%, var(--muted) 30%); }
    .pill[data-health="pending"] { border-color: rgba(148, 163, 184, 0.7); color: color-mix(in srgb, #e5f0ff 65%, #94a3b8 35%); }
    .pill[data-health="good"] { border-color: rgba(34, 197, 94, 0.8); color: color-mix(in srgb, #bbf7d0 65%, #22c55e 35%); }
    .pill[data-health="warn"] { border-color: rgba(250, 204, 21, 0.8); color: color-mix(in srgb, #fef3c7 60%, #f59e0b 40%); }
    .pill[data-health="bad"] { border-color: rgba(248, 113, 113, 0.85); color: color-mix(in srgb, #fecaca 60%, #ef4444 40%); }
    .logbox {
      margin-top:10px; max-height:160px; overflow:auto; background: #0b1018;
      background: color-mix(in srgb, rgba(5,11,31,0.92) 40%, var(--card-solid) 60%);
      border:1px solid var(--border-strong); border-radius:8px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;
    }
    .hidden { display:none; }
    footer { padding: 10px 14px; border-top: 1px solid var(--border-strong); color: var(--muted); grid-area: footer; }
    #questWidgetRoot {
      grid-area: quest;
    }
    .quest-widget {
      padding: 0 14px;
    }
    .quest-widget-panel {
      background: var(--panel-bg, rgba(12,18,28,0.92));
      border: 1px solid var(--border-strong);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: grid;
      gap: 12px;
    }
    .quest-widget-heading {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    .quest-widget-xp-total {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
    }
    .quest-widget-group {
      display: grid;
      gap: 8px;
    }
    .quest-widget-subheading {
      margin: 0;
      font-size: 14px;
      color: #d3e6ff;
    }
    .quest-widget-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }
    .quest-widget-item {
      border: 1px solid rgba(76,201,240,0.25);
      border: 1px solid color-mix(in srgb, var(--accent) 40%, transparent 60%);
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(15,22,34,0.8);
      background: color-mix(in srgb, var(--card-solid) 75%, rgba(12,18,28,0.92) 25%);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .quest-widget-item:focus-visible {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(76,201,240,0.35);
    }
    .quest-widget-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
    }
    .quest-widget-label {
      font-size: 14px;
    }
    .quest-widget-xp {
      font-size: 12px;
      color: #4cc9f0;
      font-weight: 600;
    }
    .quest-widget-progress {
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      margin-top: 8px;
      overflow: hidden;
      position: relative;
    }
    .quest-widget-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4cc9f0, #4895ef);
    }
    .quest-widget-status {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .quest-widget-item.is-complete {
      border-color: var(--accent);
      background: rgba(76,201,240,0.12);
      background: color-mix(in srgb, var(--accent) 20%, transparent 80%);
    }
    .quest-widget-item.is-complete .quest-widget-status {
      color: #7ae0ff;
      font-weight: 600;
    }
    .quest-widget-empty {
      text-align: center;
      color: var(--muted);
      font-style: italic;
    }
    .quest-widget-note {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    .mission-banner {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 5;
      max-width: min(280px, 85%);
      background: var(--panel-bg, rgba(12,18,28,0.92));
      border: 1px solid var(--border-strong);
      border-radius: 12px;
      padding: 12px 14px;
      display: grid;
      gap: 6px;
      color: var(--fg, #e5f0ff);
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
    }
    .mission-banner__kind {
      font-size: 11px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: color-mix(in srgb, var(--muted) 70%, #ffffff 30%);
    }
    .mission-banner__title {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
    }
    .mission-banner__desc {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }
    .mission-banner__progress {
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.12);
      position: relative;
    }
    .mission-banner__progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4cc9f0 0%, #4895ef 100%);
      transition: width 0.25s ease;
    }
    .mission-banner__status {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mission-banner__status strong {
      font-weight: 600;
      color: #7ae0ff;
    }
    .mission-banner__requirements {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }
    .mission-banner__loading {
      font-size: 12px;
      color: var(--muted);
    }
    .mission-banner.is-complete {
      border-color: var(--accent);
      box-shadow: 0 12px 32px rgba(72, 149, 239, 0.25);
    }
    body.legacy-shell .mission-banner {
      display: none !important;
    }
    body.legacy-shell .quest-widget {
      display: none;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }
    @media (max-width: 768px) {
      header .title h1 { font-size: 14px; }
      .mission-banner {
        position: fixed;
        top: 14px;
        left: 14px;
        right: 14px;
        max-width: none;
        pointer-events: none;
      }
      .mission-banner__status,
      .mission-banner__desc,
      .mission-banner__requirements {
        pointer-events: auto;
      }
    }
    @media (min-width: 1024px) {
      .shell-frame {
        grid-template-columns: minmax(0, 1fr) minmax(0, 320px);
        grid-template-areas:
          "header header"
          "main quest"
          "footer footer";
      }
      .quest-widget {
        align-self: start;
        justify-self: start;
        width: 100%;
        max-width: 320px;
      }
    }
  </style>
</head>
<body>
  <div class="shell-frame">
    <header aria-label="Game Shell Header">
      <div class="title">
        <a id="backLink" class="btn btn-primary" href="./index.html" aria-label="Back to home">← Back</a>
        <h1 id="gameTitle">Loading…</h1>
      </div>
      <div class="bolt-nav-actions">
        <nav>
          <button id="btnReload" class="btn" aria-label="Reload game">Reload</button>
          <button id="btnDiag" class="btn btn-ghost" aria-label="Show diagnostics">Diagnostics</button>
        </nav>
        <button type="button" class="bolt-profile-trigger" data-profile-trigger aria-haspopup="dialog" aria-expanded="false">
          <span class="sr-only">Open profile overlay</span>
          <span data-profile-avatar aria-hidden="true"></span>
          <span data-profile-name></span>
        </button>
      </div>
    </header>

    <section id="questWidgetRoot" class="quest-widget" aria-live="polite"></section>

    <main>
      <section class="game-card" aria-live="polite">
        <div class="mission-banner" id="missionBanner" aria-live="polite"></div>
        <iframe id="game-frame" title="Game frame" sandbox="allow-scripts allow-pointer-lock"></iframe>
        <div class="overlay" id="overlay" aria-hidden="false">
          <div class="status" id="statusPanel" role="status" aria-live="polite" aria-atomic="true">
            <span class="sr-only" id="statusContext">Game status message</span>
            <h2 id="statusTitle" aria-describedby="statusContext">Starting…</h2>
            <p id="statusText">We’re booting the game. First load may take a bit longer.</p>
            <div class="row">
              <span class="pill" id="pillSlug">slug: —</span>
              <span class="pill" id="pillTimer">t+0.0s</span>
              <span class="pill" id="pillSignal">signal: —</span>
              <span class="pill" id="pillHealth">health: —</span>
            </div>
            <div class="actions" id="logActions">
              <button type="button" class="btn btn-ghost" id="btnCopyLogs">Copy logs</button>
            </div>
            <div class="logbox" id="logbox" role="log" aria-live="polite"></div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      Standard shell + diagnostics active. Press <strong>Diagnostics</strong> to copy details.
    </footer>
  </div>

  <script src="./js/auto-diag-inject.js"></script>
  <script type="module" src="./js/profile-overlay.js"></script>

  <script type="module">
    import { mountQuestWidget } from './shared/quest-widget.js';
    const root = document.getElementById('questWidgetRoot');
    if (root) {
      mountQuestWidget(root, { headingLevel: 2, regionLabel: 'Quest progress tracker' });
    }
  </script>

  <script type="module">
    import { subscribe, whenReady } from './shared/missions.js';

    const params = new URLSearchParams(location.search);
    const slug = (params.get('slug') || '').trim();
    const banner = document.getElementById('missionBanner');

    const KIND_LABELS = {
      daily: 'Daily mission',
      weekly: 'Weekly mission',
      career: 'Career mission'
    };

    function selectMission(snapshot) {
      if (!snapshot?.missions) return null;
      const matches = snapshot.missions.filter(mission => mission.slug === slug);
      if (!matches.length) return null;
      const kinds = ['daily', 'weekly', 'career'];
      for (const kind of kinds) {
        const candidate = matches.find(m => m.kind === kind && !m.completed);
        if (candidate) return candidate;
      }
      for (const kind of kinds) {
        const fallback = matches.find(m => m.kind === kind);
        if (fallback) return fallback;
      }
      return matches[0];
    }

    function formatRequirements(mission) {
      if (!mission?.requirements?.length) return '';
      return mission.requirements
        .map(req => {
          if (req.target > 0) {
            const current = Math.min(req.current ?? 0, req.target);
            return `${current} / ${req.target}`;
          }
          if (req.completed) return 'Complete';
          const value = Number(req.current ?? req.raw ?? 0);
          return value > 0 ? String(value) : 'In progress';
        })
        .join(' • ');
    }

    function render(snapshot) {
      if (!banner) return;
      if (!slug) {
        banner.style.display = 'none';
        return;
      }
      banner.classList.remove('is-complete');
      if (!snapshot || snapshot.loaded === false) {
        banner.innerHTML = '<span class="mission-banner__loading">Loading missions…</span>';
        return;
      }
      const mission = selectMission(snapshot);
      if (!mission) {
        banner.innerHTML = '<span class="mission-banner__loading">No active missions for this game.</span>';
        return;
      }

      const requirementText = formatRequirements(mission);
      const pct = mission?.progress?.percentage ?? 0;
      const kindLabel = KIND_LABELS[mission.kind] || 'Mission';
      const status = mission.completed ? '<strong>Completed</strong>' : (requirementText ? `Progress: ${requirementText}` : 'Keep playing!');

      banner.classList.toggle('is-complete', !!mission.completed);
      banner.innerHTML = `
        <span class="mission-banner__kind">${kindLabel}</span>
        <h3 class="mission-banner__title">${mission.title}</h3>
        <p class="mission-banner__desc">${mission.desc}</p>
        <div class="mission-banner__progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${Math.min(100, Math.max(0, pct))}" aria-label="${mission.title} progress">
          <div class="mission-banner__progress-fill" style="width:${Math.min(100, Math.max(0, pct))}%"></div>
        </div>
        <div class="mission-banner__status">${status}</div>
      `;
    }

    if (banner) {
      const handleUpdate = snapshot => render(snapshot);
      subscribe(handleUpdate);
      whenReady().then(handleUpdate);
    }
  </script>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      let slug = (qs.get("slug") || "").trim();
      const title = qs.get("title") || "";
      const gameTitleEl = document.getElementById("gameTitle");
      const frame = document.getElementById("game-frame");
      const overlay = document.getElementById("overlay");
      const statusTitle = document.getElementById("statusTitle");
      const statusText = document.getElementById("statusText");
      const statusPanel = document.getElementById("statusPanel");
      const pillSlug = document.getElementById("pillSlug");
      const pillTimer = document.getElementById("pillTimer");
      const pillSignal = document.getElementById("pillSignal");
      const pillHealth = document.getElementById("pillHealth");
      const logbox = document.getElementById("logbox");
      const btnReload = document.getElementById("btnReload");
      const btnDiag = document.getElementById("btnDiag");
      const btnCopyLogs = document.getElementById("btnCopyLogs");

      let isLegacyShell = false;
      let sandboxTrusted = false;

      const DEFAULT_SANDBOX = "allow-scripts allow-pointer-lock";
      const TRUSTED_SANDBOX = `${DEFAULT_SANDBOX} allow-same-origin`;
      const TRUSTED_SAME_ORIGIN_SLUGS = new Set([
        "asteroids",
        "breakout",
        "chess",
        "chess3d",
        "g2048",
        "maze3d",
        "platformer",
        "pong",
        "runner",
        "shooter",
        "snake",
        "tetris",
      ]);

      const diagHandler = () => {
        const payload = [
          `slug=${slug}`, `title=${gameTitleEl.textContent}`, `signal=${pillSignal.textContent.replace("signal: ","")}`,
          `time=${secs()}`, `userAgent=${navigator.userAgent}`, `href=${location.href}`,
          `logs:`, ...Array.from(logbox.querySelectorAll("div")).map(d => "- " + d.textContent)
        ].join("\n");
        navigator.clipboard.writeText(payload).catch(()=>{});
        btnDiag.textContent = "Copied!";
        setTimeout(()=>btnDiag.textContent="Diagnostics", 1200);
      };

      let diagWired = false;
      let copyWired = false;
      let copyResetHandle = null;
      const defaultCopyLabel = "Copy logs";

      function resetCopyButton() {
        if (!btnCopyLogs) return;
        btnCopyLogs.disabled = false;
        btnCopyLogs.textContent = defaultCopyLabel;
      }

      function handleCopyLogs() {
        if (!btnCopyLogs) return;
        const text = Array.from(logbox.children).map(div => div.textContent || "").join("\n");
        if (!navigator.clipboard || typeof navigator.clipboard.writeText !== "function") {
          btnCopyLogs.textContent = "Copy unavailable";
          clearTimeout(copyResetHandle);
          copyResetHandle = setTimeout(resetCopyButton, 1500);
          return;
        }
        btnCopyLogs.disabled = true;
        btnCopyLogs.textContent = "Copying…";
        navigator.clipboard.writeText(text)
          .then(() => {
            btnCopyLogs.textContent = "Copied!";
          })
          .catch(() => {
            btnCopyLogs.textContent = "Copy failed";
          })
          .finally(() => {
            clearTimeout(copyResetHandle);
            copyResetHandle = setTimeout(resetCopyButton, 1500);
          });
      }

      function wireDiagButton() {
        if (!btnDiag) return;
        if (!diagWired) {
          btnDiag.addEventListener("click", diagHandler);
          diagWired = true;
        }
        btnDiag.classList.remove("hidden");
        btnDiag.removeAttribute("aria-hidden");
        btnDiag.removeAttribute("tabindex");
        if (btnCopyLogs) {
          if (!copyWired) {
            btnCopyLogs.addEventListener("click", handleCopyLogs);
            copyWired = true;
          }
          btnCopyLogs.classList.remove("hidden");
          btnCopyLogs.removeAttribute("aria-hidden");
          btnCopyLogs.removeAttribute("tabindex");
          resetCopyButton();
        }
      }

      function unwireDiagButton() {
        if (!btnDiag) return;
        if (diagWired) {
          btnDiag.removeEventListener("click", diagHandler);
          diagWired = false;
        }
        btnDiag.classList.add("hidden");
        btnDiag.setAttribute("aria-hidden", "true");
        btnDiag.setAttribute("tabindex", "-1");
        btnDiag.textContent = "Diagnostics";
        if (btnCopyLogs) {
          if (copyWired) {
            btnCopyLogs.removeEventListener("click", handleCopyLogs);
            copyWired = false;
          }
          btnCopyLogs.classList.add("hidden");
          btnCopyLogs.setAttribute("aria-hidden", "true");
          btnCopyLogs.setAttribute("tabindex", "-1");
          clearTimeout(copyResetHandle);
          copyResetHandle = null;
          resetCopyButton();
        }
      }

      function applySandbox(allowTrusted) {
        sandboxTrusted = Boolean(allowTrusted);
        const sandboxValue = sandboxTrusted ? TRUSTED_SANDBOX : DEFAULT_SANDBOX;
        if (frame.getAttribute("sandbox") !== sandboxValue) {
          frame.setAttribute("sandbox", sandboxValue);
          write(`sandbox mode set → ${sandboxValue}`);
        }
      }

      // Normalize 2048 → g2048 (keeps existing links working)
      if (slug === "2048") slug = "g2048";

      const trustedSameOrigin = Boolean(slug && TRUSTED_SAME_ORIGIN_SLUGS.has(slug));

      // Fallback title
      gameTitleEl.textContent = title || (slug ? slug.replace(/[-_]/g, " ") : "Unknown Game");

      // Helper: log
      const t0 = performance.now();
      function secs() { return ((performance.now() - t0) / 1000).toFixed(1) + "s"; }
      function setTimer() { pillTimer.textContent = "t+" + secs(); }
      setInterval(setTimer, 100);

      function write(line) {
        const ts = secs();
        const msg = `[${ts}] ${line}`;
        const div = document.createElement("div");
        div.textContent = msg;
        logbox.appendChild(div);
        logbox.scrollTop = logbox.scrollHeight;
      }

      const assetExtPattern = /\.(?:m?js|css|png|jpe?g|webp|svg|json|mp3|wav|ogg)(?:[?#]|$)/i;
      let assetPreflightStarted = false;

      function setHealthPill(text, state) {
        if (!pillHealth) return;
        pillHealth.textContent = text;
        if (state) {
          pillHealth.dataset.health = state;
        } else {
          delete pillHealth.dataset.health;
        }
      }

      function collectAssetUrls(html, baseUrl) {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const elements = doc.querySelectorAll("script[src], link[href], img[src], img[srcset], audio[src], video[src], source[src], source[srcset], track[src]");
          const urls = new Set();

          const tryAddUrl = (raw) => {
            if (!raw) return;
            try {
              const url = new URL(raw, baseUrl);
              if (assetExtPattern.test(url.pathname)) {
                urls.add(url.href);
              }
            } catch (error) {
              // Ignore malformed URLs
            }
          };

          elements.forEach((el) => {
            if (el.tagName === "LINK") {
              tryAddUrl(el.getAttribute("href"));
              return;
            }

            tryAddUrl(el.getAttribute("src"));

            if (el.hasAttribute("srcset")) {
              const srcset = el.getAttribute("srcset");
              if (srcset) {
                srcset.split(",").forEach((entry) => {
                  const candidate = entry.trim().split(/\s+/)[0];
                  tryAddUrl(candidate);
                });
              }
            }
          });

          const importMapScripts = doc.querySelectorAll('script[type="importmap"]');
          importMapScripts.forEach((script) => {
            const text = script.textContent;
            if (!text) return;
            try {
              const map = JSON.parse(text);
              if (!map || typeof map !== "object") {
                return;
              }

              const processImports = (imports) => {
                if (!imports || typeof imports !== "object") return;
                Object.values(imports).forEach((value) => {
                  if (typeof value === "string") {
                    tryAddUrl(value);
                  }
                });
              };

              processImports(map.imports);

              if (map.scopes && typeof map.scopes === "object") {
                Object.values(map.scopes).forEach((scopeImports) => {
                  processImports(scopeImports);
                });
              }
            } catch (error) {
              write("preflight importmap parse error: " + (error && error.message ? error.message : error));
            }
          });
          return Array.from(urls);
        } catch (err) {
          write("preflight parse error: " + (err && err.message ? err.message : err));
          return [];
        }
      }

      function headWithTimeout(url, timeoutMs) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), timeoutMs);
        return fetch(url, { method: "HEAD", signal: controller.signal })
          .then((resp) => resp.ok)
          .catch(() => false)
          .finally(() => clearTimeout(timeout));
      }

      function startAssetPreflight(wrapperUrl) {
        if (assetPreflightStarted) return;
        assetPreflightStarted = true;

        if (!pillHealth) return;
        if (!slug || !wrapperUrl) {
          setHealthPill("health: n/a", "warn");
          return;
        }

        const baseUrl = new URL(wrapperUrl, location.href);
        setHealthPill("health: scanning…", "pending");

        fetch(baseUrl.href)
          .then((resp) => {
            if (!resp.ok) {
              throw new Error(`status ${resp.status}`);
            }
            return resp.text();
          })
          .then((html) => {
            const assets = collectAssetUrls(html, baseUrl);
            if (!assets.length) {
              setHealthPill("health: 0/0 OK", "bad");
              write("preflight: no assets discovered");
              return;
            }

            let okCount = 0;
            let completed = 0;
            const failures = [];

            const updatePill = (final = false) => {
              const text = `health: ${okCount}/${assets.length} OK`;
              const state = final
                ? (() => {
                    const ratio = okCount / assets.length;
                    if (ratio >= 0.9) return "good";
                    if (ratio >= 0.6) return "warn";
                    return "bad";
                  })()
                : "pending";
              setHealthPill(text, state);
            };

            updatePill(false);

            const timeoutMs = 1500;
            return Promise.allSettled(assets.map((url) => {
              return headWithTimeout(url, timeoutMs).then((ok) => {
                completed += 1;
                if (ok) {
                  okCount += 1;
                } else {
                  failures.push(url);
                }
                updatePill(completed === assets.length);
              });
            })).then(() => {
              updatePill(true);
              write(`preflight: ${okCount}/${assets.length} assets OK`);
              if (failures.length) {
                failures.slice(0, 3).forEach((url) => write(`preflight fail: ${url}`));
              }
            });
          })
          .catch((err) => {
            setHealthPill("health: wrapper fetch failed", "bad");
            write("preflight skipped: " + (err && err.message ? err.message : err));
          });
      }

      // Wire buttons
      btnReload.addEventListener("click", () => {
        write("manual: reload requested");
        if (sandboxTrusted) {
          try {
            frame.contentWindow?.location.reload();
          } catch (err) {
            write("reload fallback (trusted sandbox error): " + (err && err.message ? err.message : err));
            frame.src = frame.src;
          }
        } else {
          write("reload fallback (strict sandbox)");
          frame.src = frame.src;
        }
      });
      // Load the game iframe
      pillSlug.textContent = "slug: " + (slug || "—");

      function setFrameSrc(src, note, options = {}) {
        const { legacy = false, trustedSameOrigin: allowSameOrigin = false } = options;
        applySandbox(!legacy && allowSameOrigin);
        frame.src = src;
        isLegacyShell = legacy;
        if (legacy) {
          unwireDiagButton();
        } else {
          wireDiagButton();
        }
        write(`iframe src set → ${src}${note ? ` (${note})` : ""}`);
        startAssetPreflight(src);
      }

      if (!slug) {
        setFrameSrc("./404.html", "missing slug", { legacy: true });
      } else {
        const modernSrc = `./gameshells/${slug}/index.html`;
        const legacySrc = `./games/${slug}/index.html`;

        write(`checking modern wrapper → ${modernSrc}`);

        const forceLegacy = qs.has('legacy') || qs.get('shell') === 'legacy';
        const forceModern = qs.has('modern') || qs.get('shell') === 'modern';
        if (forceLegacy) {
          setFrameSrc(legacySrc, "forced legacy", { legacy: true });
        } else if (forceModern) {
          setFrameSrc(modernSrc, "forced modern", { trustedSameOrigin });
        } else {
          fetch(modernSrc, { method: "HEAD" })
            .then((resp) => {
              if (resp.ok) {
                setFrameSrc(modernSrc, "modern wrapper", { trustedSameOrigin });
              } else {
                setFrameSrc(legacySrc, `legacy fallback (status ${resp.status})`, { legacy: true });
              }
            })
            .catch((err) => {
              setFrameSrc(legacySrc, `legacy fallback (${err && err.message ? err.message : err})`, { legacy: true });
            });
        }
      }


      frame.addEventListener("load", () => {
        write("iframe loaded");
        if (isLegacyShell) {
          document.body.classList.add("legacy-shell");
          unwireDiagButton();
        } else {
          document.body.classList.remove("legacy-shell");
          wireDiagButton();
        }
        try {
          const mark = frame.contentWindow && frame.contentWindow.__gg_autoSignalInstalled;
          write("child autosignal: " + (mark ? "present" : "absent/x-origin"));
        } catch (e) {
          write("child-access error (likely cross-origin): " + (e && e.message ? e.message : e));
        }
      });


      // Signal handling
      let signalled = false;
      window.addEventListener("message", (ev) => {
        if (ev.source !== frame.contentWindow) return;
        if (ev.origin && ev.origin !== location.origin) return;
        const data = ev.data;
        if (!data || typeof data !== "object") return;
        if (data.type === "GAME_READY") {
          signalled = true;
          pillSignal.textContent = "signal: GAME_READY";
          statusTitle.textContent = "Ready";
          statusText.textContent = "Have fun!";
          overlay.classList.add("hidden");
          overlay.setAttribute("aria-hidden", "true");
          if (statusPanel) statusPanel.setAttribute("aria-hidden", "true");
          write("signal: GAME_READY");
        } else if (data.type === "GAME_ERROR") {
          signalled = true;
          pillSignal.textContent = "signal: GAME_ERROR";
          statusTitle.textContent = "Oops, this game didn't load.";
          statusText.textContent = data.error ? String(data.error) : "Check the console for details.";
          overlay.classList.remove("hidden");
          overlay.setAttribute("aria-hidden", "false");
          if (statusPanel) statusPanel.setAttribute("aria-hidden", "false");
          write("signal: GAME_ERROR " + (data.error || ""));
        }
      });

      // Timeout if no signal in 6s
      setTimeout(() => {
        if (!signalled) {
          pillSignal.textContent = "signal: (none)";
          statusTitle.textContent = "No signal from game";
          statusText.textContent = "We didn’t receive GAME_READY/ERROR within 6 seconds. The game may still be loading or failed silently.";
          overlay.classList.remove("hidden");
          overlay.setAttribute("aria-hidden", "false");
          if (statusPanel) statusPanel.setAttribute("aria-hidden", "false");
          write("timeout: no GAME_READY/ERROR within 6s");
        }
      }, 6000);

      // Bubble up errors from shell too
      window.addEventListener("error", (e) => write("shell error: " + (e.message || e.error || e)));
      window.addEventListener("unhandledrejection", (e) => write("shell rejection: " + (e.reason || e)));
    })();
  </script>
</body>
</html>
